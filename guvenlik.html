<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA G√ºvenlik Sistemi - G√ºvenlik Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #2c3e50, #34495e); color:#ecf0f1; overflow-x:hidden; }
  .container { display:flex; flex-direction:column; align-items:center; justify-content:flex-start; padding:20px; transition: transform 0.3s ease; }
  header { text-align:center; margin-bottom:20px; }
  button { padding:12px 18px; margin:6px; border-radius:10px; border:none; cursor:pointer; font-weight:600; transition:0.3s; }
  button:hover { opacity:0.9; }
  #nobetAlBtn { background-color: #2980b9; color:#fff; }
  #nobetBitirBtn { background-color: #c0392b; color:#fff; }
  #devriyeStartBtn { background-color: #2980b9; color:#fff; }
  #devriyeEndBtn { background-color: #c0392b; color:#fff; }
  .status { margin:12px 0; padding:12px; background: rgba(0,0,0,0.2); border-radius:10px; width:100%; text-align:center; font-size:16px; }
  .panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); width:100%; margin-top:20px; }
  .panel h2 { margin-top:0; text-align:center; }
  .qr-list div { margin-bottom:12px; display:flex; align-items:center; justify-content:space-between; }
  .qr-list button.qrBtn { background-color: #7f8c8d; color:#fff; flex-shrink:0; width:120px; }
  .qr-list button.qrBtn.read { background-color:#27ae60; }

  input[type=date], input[type=text], input[type=password] { padding:6px; border-radius:8px; border:none; font-size:14px; }

  /* Tek ikonlu saƒü panel */
  #historyToggleBtn {
    position:fixed; top:20px; right:20px; background:#f39c12; color:#fff;
    border:none; border-radius:50%; width:50px; height:50px;
    font-size:24px; z-index:1001; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }
  #historyPanel {
    position:fixed; top:0; right:-100%;
    width:320px; height:100%;
    background: rgba(44,62,80,0.95);
    color:#fff;
    box-shadow: -6px 0 20px rgba(0,0,0,0.4);
    padding:20px;
    transition: right 0.3s ease;
    overflow-y:auto;
    z-index:1000;
  }
  #historyPanel h2 { text-align:center; margin-top:0; }

  .profileIcon {
    position:fixed; top:20px; left:20px; background:#16a085; color:#fff;
    border:none; border-radius:50%; width:50px; height:50px;
    font-size:24px; z-index:1001; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
  }

  @media (min-width:600px){
    .container { max-width:600px; margin:auto; }
  }

  /* === QR KAMERA MODALI (Tam Ekran) === */
  #qrScannerModal {
    display:none; position:fixed; inset:0; background:#000; z-index:9999;
    flex-direction:column; align-items:center; justify-content:center;
    padding:16px;
  }
  #qr-reader { width:100%; max-width:520px; }
  #closeScanner {
    margin-top:20px; padding:12px 18px; border:none; border-radius:10px;
    background:#c0392b; color:#fff; font-weight:700; cursor:pointer;
  }
</style>
</head>
<body>

<!-- Profil ikonu -->
<button class="profileIcon" id="profileBtn">&#128100;</button>

<!-- Tek ikon: Devriye Ge√ßmi≈üi -->
<button id="historyToggleBtn">&#128221;</button> 

<div id="historyPanel">
  <h2>Devriye Ge√ßmi≈üi</h2>
  <label for="filterDate">Tarih Filtrele:</label>
  <input type="date" id="filterDate">
  <div id="devriyeHistory"></div>
</div>

<!-- Profil Modal -->
<div id="profileModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px;">
  <span id="profileClose" style="position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff;">‚úñ</span>
  <h3 style="text-align:center;">Profil</h3>
  
  <label>Kullanƒ±cƒ± Adƒ± (deƒüi≈ütirilemez)</label>
  <input type="text" id="profileUsername" disabled style="width:100%; padding:8px; border-radius:8px; border:none; background:#333; color:#fff; font-weight:600;">
  
  <label>Eski ≈ûifre</label>
  <div style="position:relative; width:100%; display:flex; align-items:center;">
    <input type="password" id="oldPassword" style="flex:1; padding:8px 40px 8px 8px; border-radius:8px; border:none;">
    <span class="togglePassword" data-target="oldPassword" style="position:absolute; right:8px; cursor:pointer;">üëÅÔ∏è</span>
  </div>

  <label>Yeni ≈ûifre</label>
  <div style="position:relative; width:100%; display:flex; align-items:center;">
    <input type="password" id="newPassword" style="flex:1; padding:8px 40px 8px 8px; border-radius:8px; border:none;">
    <span class="togglePassword" data-target="newPassword" style="position:absolute; right:8px; cursor:pointer;">üëÅÔ∏è</span>
  </div>

  <label>Telefon Numarasƒ±</label>
  <input type="text" id="phoneNumber" placeholder="+90..." style="width:100%; padding:8px; border-radius:8px; border:none;">
  
  <button id="updateProfileBtn" style="width:100%; padding:10px; margin-top:12px; border:none; border-radius:8px; background:#27ae60; color:#fff; font-weight:600;">G√ºncelle</button>
  <button id="logoutBtn" style="width:100%; padding:10px; margin-top:8px; border:none; border-radius:8px; background:#c0392b; color:#fff; font-weight:600;">√áƒ±kƒ±≈ü</button>

  <div id="profileMessage" style="margin-top:10px; font-size:14px;"></div>
</div>

<div class="container" id="mainContainer">
  <header>
    <h1>CGA G√ºvenlik Sistemi - G√ºvenlik Paneli</h1>
  </header>

  <!-- N√∂bet -->
  <button id="nobetAlBtn">N√∂beti Teslim Al</button>
  <button id="nobetBitirBtn" disabled>N√∂beti Teslim Ettim</button>
  <div class="status" id="nobetStatus">Hen√ºz n√∂bette deƒüilsiniz.</div>
  <div id="nobetTimer" style="margin-top:8px; font-weight:bold;"></div>

  <!-- Devriye -->
  <div class="panel">
    <h2>Devriye</h2>
    <button id="devriyeStartBtn">Devriye Ba≈ülat</button>
    <button id="devriyeEndBtn" disabled>Devriyeyi Bitir</button>
    <div class="status" id="devriyeStatus">Devriye ba≈ülamadƒ±.</div>

    <h3>Devriye Noktalarƒ±</h3>
    <div class="qr-list" id="qrListContainer"></div>
  </div>
</div>

<!-- === QR Kamerasƒ± Modalƒ± === -->
<div id="qrScannerModal">
  <div id="qr-reader"></div>
  <button id="closeScanner">Kapat</button>
</div>

<script src="https://unpkg.com/html5-qrcode"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* === Firebase === */
const firebaseConfig = {
  apiKey: "AIzaSyBX0PUaisTG-TvIOCCtKzSiI3e7yhLu3ik",
  authDomain: "guzelailemchat.firebaseapp.com",
  databaseURL: "https://guzelailemchat-default-rtdb.firebaseio.com",
  projectId: "guzelailemchat",
  storageBucket: "guzelailemchat.firebasestorage.app",
  messagingSenderId: "353492004109",
  appId: "1:353492004109:web:3a668422a563e6951cd444"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

/* === Session kontrol === */
const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
if(!currentUser || currentUser.type!=='security'){
  alert("G√ºvenlik kullanƒ±cƒ± ile giri≈ü yapmalƒ±sƒ±nƒ±z!");
  window.location.href="login.html";
}

/* === Profil modal ve i≈ülemleri === */
const profileBtn = document.getElementById("profileBtn");
const profileModal = document.getElementById("profileModal");
const profileClose = document.getElementById("profileClose");
const profileUsername = document.getElementById("profileUsername");
const oldPassword = document.getElementById("oldPassword");
const newPassword = document.getElementById("newPassword");
const phoneNumber = document.getElementById("phoneNumber");
const updateProfileBtn = document.getElementById("updateProfileBtn");
const profileMessage = document.getElementById("profileMessage");
const logoutBtn = document.getElementById("logoutBtn");

oldPassword.addEventListener('input', ()=>{ oldPassword.value = oldPassword.value.toUpperCase(); });
newPassword.addEventListener('input', ()=>{ newPassword.value = newPassword.value.toUpperCase(); });

profileUsername.value = currentUser.name || currentUser.username || "";

profileBtn.addEventListener('click', ()=>{ profileModal.style.display='block'; });
profileClose.addEventListener('click', ()=>{ profileModal.style.display='none'; });

updateProfileBtn.addEventListener('click', async ()=> {
  profileMessage.innerText='';
  if(!oldPassword.value && !newPassword.value && !phoneNumber.value) return;

  const key = currentUser.username;
  const userRef = ref(db, 'users/'+key);

  const snapshot = await get(userRef);
  const user = snapshot.val();
  if(!user){ profileMessage.innerText="Kullanƒ±cƒ± bulunamadƒ±."; return; }

  if(oldPassword.value && oldPassword.value !== user.password){
    profileMessage.innerText="Eski ≈üifre hatalƒ±!"; return;
  }

  const updates = {};
  if(newPassword.value) updates.password = newPassword.value;
  if(phoneNumber.value) updates.phone = phoneNumber.value;

  await update(userRef, updates);
  profileMessage.innerText="Profil ba≈üarƒ±yla g√ºncellendi!";
  oldPassword.value=''; newPassword.value=''; phoneNumber.value='';
  if(updates.password) currentUser.password = updates.password;
  if(updates.phone) currentUser.phone = updates.phone;
  sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
});

// ≈ûifre g√∂ster/gizle
document.querySelectorAll('.togglePassword').forEach(el=>{
  el.addEventListener('click', ()=>{
    const input = document.getElementById(el.dataset.target);
    if(input.type === "password"){ input.type = "text"; el.innerText = "üôà"; } 
    else { input.type = "password"; el.innerText = "üëÅÔ∏è"; }
  });
});

phoneNumber.addEventListener('input', () => {
    phoneNumber.value = phoneNumber.value.replace(/\D/g, '');
});

logoutBtn.addEventListener('click', ()=>{ sessionStorage.removeItem('currentUser'); window.location.href = "index.html"; });

/* === Panel elemanlarƒ± === */
const nobetAlBtn = document.getElementById("nobetAlBtn");
const nobetBitirBtn = document.getElementById("nobetBitirBtn");
const nobetStatus = document.getElementById("nobetStatus");
const devriyeStartBtn = document.getElementById("devriyeStartBtn");
const devriyeEndBtn = document.getElementById("devriyeEndBtn");
const devriyeHistoryEl = document.getElementById("devriyeHistory");
const filterDate = document.getElementById("filterDate");
const historyToggleBtn = document.getElementById("historyToggleBtn");
const historyPanel = document.getElementById("historyPanel");
const mainContainer = document.getElementById("mainContainer");
const qrListContainer = document.getElementById('qrListContainer');

nobetAlBtn.addEventListener('click', (e)=>{ 
  e.stopImmediatePropagation();
  window.location.href = "nobet.html";
});

nobetBitirBtn.addEventListener('click', (e)=>{ 
  e.stopImmediatePropagation();
  window.location.href = "nobet.html";
});

/* === QR Modal === */
const qrModal = document.getElementById('qrScannerModal');
const qrReaderDivId = 'qr-reader';
const closeScanner = document.getElementById('closeScanner');
let qrScanner = null;

let devriyeStarted=false, devriyeStartTime=null, readPoints=[], allDevriyeHistory=[];

/* === N√∂bet durumu (nobetRecords bazlƒ±) */
const nobetRecordsRef = ref(db,'nobetRecords');
onValue(nobetRecordsRef, snapshot=>{
  const val = snapshot.val();
  let activeRecord = null;

  if(val){
    Object.values(val).forEach(rec=>{
      if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
        activeRecord = rec;
      }
    });
  }

  let nobetTimerInterval = null;

  if(activeRecord){
    nobetStatus.innerText = `üëÆ ${activeRecord.startBy} | üß≠ ${activeRecord.startPoint} - N√∂bettesin`;
    nobetAlBtn.disabled = true;
    nobetBitirBtn.disabled = false;

    const startTime = new Date(activeRecord.startTime);
    clearInterval(nobetTimerInterval);
    nobetTimerInterval = setInterval(()=>{
      const now = new Date();
      const diff = Math.floor((now - startTime)/1000);
      const h = String(Math.floor(diff/3600)).padStart(2,'0');
      const m = String(Math.floor((diff%3600)/60)).padStart(2,'0');
      const s = String(diff%60).padStart(2,'0');
      document.getElementById("nobetTimer").innerText = `‚è±Ô∏è S√ºre: ${h}:${m}:${s}`;
    },1000);

  } else {
    nobetStatus.innerText = 'Hen√ºz n√∂bette deƒüilsiniz.';
    document.getElementById("nobetTimer").innerText = '';
    nobetAlBtn.disabled = false;
    nobetBitirBtn.disabled = true;
    clearInterval(nobetTimerInterval);
  }

});

/* === N√∂bet al/bitir butonlarƒ± === */
nobetAlBtn.addEventListener('click', ()=>{ 
  const newRecord = {
    fromSecurity: currentUser.username || currentUser.name,
    startBy: currentUser.name || currentUser.username,
    startPoint: 'D BLOK',
    startTime: new Date().toISOString(),
    status: 'started'
  };
  push(nobetRecordsRef, newRecord);
});

nobetBitirBtn.addEventListener('click', ()=> {
  get(nobetRecordsRef).then(snapshot=>{
    const val = snapshot.val();
    if(val){
      Object.entries(val).forEach(([key, rec])=>{
        if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
          update(ref(db,'nobetRecords/'+key), {status:'ended', endTime:new Date().toISOString()});
        }
      });
    }
  });
});

/* === Devriye akƒ±≈üƒ± === */
devriyeStartBtn.addEventListener('click', async ()=> {
  // N√∂beti almƒ±≈ü mƒ± kontrol et
  const valSnapshot = await get(nobetRecordsRef);
  const val = valSnapshot.val();
  let activeNobet = null;
  
  if(val){
    Object.values(val).forEach(rec=>{
      if(rec.startBy === (currentUser.name || currentUser.username) && rec.status==='started'){
        activeNobet = rec;
      }
    });
  }

  if(!activeNobet){
    alert("Devriyeye ba≈ülamadan √∂nce n√∂beti almalƒ±sƒ±nƒ±z!");
    return;
  }

  if(devriyeStarted) return;

  devriyeStarted = true;
  devriyeStartTime = new Date();
  devriyeStatus.innerText = 'Devriye ba≈üladƒ±: ' + devriyeStartTime.toLocaleTimeString();
  devriyeEndBtn.disabled = false;
  readPoints = [];
  document.querySelectorAll('.qrBtn').forEach(btn=>{ 
    btn.classList.remove('read'); 
    btn.nextElementSibling.innerText = btn.dataset.point; 
  });
});

devriyeEndBtn.addEventListener('click', async ()=>{
  if(!devriyeStarted) return;

  const devriyeData = {
    security: currentUser.name || currentUser.username,
    startTime: devriyeStartTime.toISOString(),
    endTime: new Date().toISOString(),
    points: readPoints
  };
  const devriyeHistoryRef = ref(db,'devriyeRecords');
  await push(devriyeHistoryRef, devriyeData);

  devriyeStarted=false;
  devriyeStatus.innerText='Devriye tamamlandƒ±.';
  devriyeEndBtn.disabled=true;
});

/* === Devriye ge√ßmi≈ü paneli === */
historyToggleBtn.addEventListener('click', ()=>{
  if(historyPanel.style.right==='0px'){ historyPanel.style.right='-100%'; }
  else{ historyPanel.style.right='0px'; }
});

const devriyeRecordsRef = ref(db,'devriyeRecords');
onValue(devriyeRecordsRef, snapshot=>{
  const val = snapshot.val();
  allDevriyeHistory = val ? Object.values(val) : [];
  renderDevriyeHistory();
});

filterDate.addEventListener('change', renderDevriyeHistory);

function renderDevriyeHistory(){
  const filter = filterDate.value;
  devriyeHistoryEl.innerHTML='';
  allDevriyeHistory.forEach(rec=>{
    if(filter){
      const recDate = new Date(rec.startTime).toISOString().split('T')[0];
      if(recDate!==filter) return;
    }
    const div = document.createElement('div');
    div.style.borderBottom='1px solid #444';
    div.style.padding='8px 0';
    div.innerHTML=`<b>${rec.security}</b><br>${new Date(rec.startTime).toLocaleString()} - ${new Date(rec.endTime).toLocaleString()}<br>Puanlar: ${rec.points.join(', ')}`;
    devriyeHistoryEl.appendChild(div);
  });
}

</script>
</body>
</html>
